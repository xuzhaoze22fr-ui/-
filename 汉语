<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HSK1 å†™å­— & è¯æ±‡ç»ƒä¹ </title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#111a2b;
      --card2:#0f1526;
      --text:#e8eefc;
      --muted:#aab7d6;
      --line:rgba(255,255,255,.12);
      --brand:#7aa2ff;
      --brand2:#6ee7ff;
      --ok:#34d399;
      --bad:#fb7185;
      --radius:18px;
      --shadow:0 16px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1100px 500px at 18% 10%, rgba(122,162,255,.20), transparent 55%),
        radial-gradient(900px 500px at 85% 25%, rgba(110,231,255,.16), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .container{max-width:1120px; margin:0 auto; padding:22px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,26,43,.75);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .logo{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg, var(--brand), var(--brand2));}
    .muted{color:var(--muted)}
    .pill{
      padding:8px 12px; border:1px solid var(--line);
      border-radius:999px; background: rgba(255,255,255,.03);
      color:var(--muted); cursor:pointer; font-size:13px;
      transition: all .15s ease;
      user-select:none;
    }
    .pill:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55); color:var(--text);}
    .pill.active{border-color: rgba(122,162,255,.60); color:var(--text);}
    .grid{display:grid; gap:14px; margin-top:16px; grid-template-columns: 1fr 1fr;}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,26,43,.70);
      box-shadow: var(--shadow);
      padding:16px;
    }
    h1{font-size:18px; margin:0;}
    h2{font-size:16px; margin:0 0 10px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select, input[type="text"], textarea{
      width:100%;
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: rgba(11,15,25,.60); color:var(--text); outline:none;
    }
    textarea{min-height:130px; resize:vertical;}
    select:focus, input:focus, textarea:focus{border-color: rgba(122,162,255,.70);}
    .btn{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer; font-weight:700;
      transition: all .15s ease;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(110,231,255,.95));
      color:#071022; border-color: transparent;
    }
    .btn.danger{border-color: rgba(251,113,133,.55);}
    .btn.ok{border-color: rgba(52,211,153,.55);}
    .split{display:grid; gap:12px; grid-template-columns: 1fr 1fr;}
    @media (max-width: 680px){ .split{grid-template-columns: 1fr;} }

    /* Flashcard */
    .flash{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding:14px;
    }
    .bigHan{font-size:54px; font-weight:900; line-height:1; margin:4px 0;}
    .small{font-size:14px; color:var(--muted); line-height:1.6;}
    .meta{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .chip{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
    }

    /* Drawing pad */
    .padWrap{
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .padTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .padTop label{font-size:12px; color:var(--muted);}
    .padTop input[type="range"]{width:140px;}
    canvas{display:block; width:100%; height:380px; touch-action:none; background: #0a1020;}
    .hint{
      font-size:12px; color:var(--muted); margin-top:10px;
    }

    /* Quiz */
    .qBox{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding:14px;
    }
    .opt{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.02);
      cursor:pointer;
      margin-top:10px;
      transition: all .12s ease;
    }
    .opt:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55);}
    .opt.good{border-color: rgba(52,211,153,.65);}
    .opt.bad{border-color: rgba(251,113,133,.65);}
    .score{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-top:10px; color:var(--muted); font-size:13px;
    }
    .kbd{border:1px solid var(--line); border-bottom-width:2px; padding:2px 6px; border-radius:8px; color:var(--muted); font-size:12px;}
    .footer{margin:14px 0 30px; color:var(--muted); font-size:13px;}
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-size:14px;">HSK1 å†™å­— & è¯æ±‡ç»ƒä¹ </div>
          <div class="muted" style="font-size:12px;">Flashcards Â· é»˜å†™ Â· ç»ƒå­—æ¿ Â· å°æµ‹éªŒ</div>
        </div>
      </div>
      <div class="row">
        <div class="pill active" data-view="vocab">è¯æ±‡å¡</div>
        <div class="pill" data-view="dictation">é»˜å†™</div>
        <div class="pill" data-view="writing">å†™å­—æ¿</div>
        <div class="pill" data-view="quiz">æµ‹éªŒ</div>
        <div class="pill" data-view="custom">è‡ªå®šä¹‰è¯åº“</div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: main -->
      <div class="card" id="mainCard">
        <!-- Views rendered here -->
      </div>

      <!-- Right: controls / print -->
      <div class="card">
        <h2>âš™ï¸ è®¾ç½®</h2>
        <div class="split">
          <div>
            <div class="muted" style="font-size:12px; margin-bottom:6px;">è¯åº“</div>
            <select id="deckSelect"></select>
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin-bottom:6px;">ç­›é€‰</div>
            <input id="search" type="text" placeholder="æœç´¢ï¼šä¸­æ–‡ / æ‹¼éŸ³ / è‹±æ–‡â€¦" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="togglePinyin">ğŸ‘€ æ‹¼éŸ³ï¼šæ˜¾ç¤º</button>
          <button class="btn" id="toggleEnglish">ğŸ‘€ è‹±æ–‡ï¼šæ˜¾ç¤º</button>
          <button class="btn" id="shuffle">ğŸ”€ æ‰“ä¹±</button>
          <button class="btn ok" id="reset">â†©ï¸ é‡ç½®</button>
        </div>

        <div style="margin-top:14px;">
          <h2>ğŸ–¨ æ‰“å°ç»ƒå­—çº¸</h2>
          <p class="muted" style="margin:0 0 10px; font-size:13px;">
            ä¼šæ‰“å¼€ä¸€ä¸ªæ–°çª—å£ï¼šæ¯ä¸ªè¯ä¸€è¡Œ + å¤šä¸ªç©ºæ ¼ï¼Œç”¨æ¥å†™å­—/é»˜å†™ã€‚
          </p>
          <div class="row">
            <button class="btn primary" id="printSheet">æ‰“å° A4</button>
            <select id="repeatCount" style="max-width:180px;">
              <option value="6">æ¯è¡Œ 6 ä¸ªæ ¼</option>
              <option value="8">æ¯è¡Œ 8 ä¸ªæ ¼</option>
              <option value="10">æ¯è¡Œ 10 ä¸ªæ ¼</option>
            </select>
          </div>
        </div>

        <div class="footer">
          <div>å¿«æ·é”®ï¼š<span class="kbd">â†</span>/<span class="kbd">â†’</span> åˆ‡æ¢è¯ï¼Œ<span class="kbd">Space</span> ç¿»é¢ï¼ˆåœ¨è¯æ±‡å¡/é»˜å†™é‡Œï¼‰</div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ======================
 *  HSK1 Demo Decks
 *  ä½ å¯ä»¥æŠŠå®ƒæ¢æˆä½ è¯¾å ‚çš„è¯
 *  format: {han, pinyin, en}
 * ====================== */
const DECKS = {
  "HSK1 åŸºç¡€ï¼ˆç¤ºä¾‹ 40ï¼‰": [
    {han:"æˆ‘", pinyin:"wÇ’", en:"I / me"},
    {han:"ä½ ", pinyin:"nÇ", en:"you"},
    {han:"ä»–", pinyin:"tÄ", en:"he / him"},
    {han:"å¥¹", pinyin:"tÄ", en:"she / her"},
    {han:"æˆ‘ä»¬", pinyin:"wÇ’men", en:"we"},
    {han:"è¿™", pinyin:"zhÃ¨", en:"this"},
    {han:"é‚£", pinyin:"nÃ ", en:"that"},
    {han:"å“ª", pinyin:"nÇ", en:"which / where"},
    {han:"ä¸", pinyin:"bÃ¹", en:"not"},
    {han:"å¾ˆ", pinyin:"hÄ›n", en:"very"},
    {han:"å—", pinyin:"ma", en:"(question particle)"},
    {han:"å‘¢", pinyin:"ne", en:"(topic particle)"},
    {han:"çš„", pinyin:"de", en:"(possession particle)"},
    {han:"æ˜¯", pinyin:"shÃ¬", en:"to be"},
    {han:"æœ‰", pinyin:"yÇ’u", en:"to have"},
    {han:"åœ¨", pinyin:"zÃ i", en:"to be at / in"},
    {han:"å»", pinyin:"qÃ¹", en:"to go"},
    {han:"æ¥", pinyin:"lÃ¡i", en:"to come"},
    {han:"åƒ", pinyin:"chÄ«", en:"to eat"},
    {han:"å–", pinyin:"hÄ“", en:"to drink"},
    {han:"çœ‹", pinyin:"kÃ n", en:"to see / watch"},
    {han:"å¬", pinyin:"tÄ«ng", en:"to listen"},
    {han:"è¯´", pinyin:"shuÅ", en:"to speak"},
    {han:"å­¦", pinyin:"xuÃ©", en:"to learn"},
    {han:"ä¹°", pinyin:"mÇi", en:"to buy"},
    {han:"é’±", pinyin:"qiÃ¡n", en:"money"},
    {han:"äºº", pinyin:"rÃ©n", en:"person"},
    {han:"å®¶", pinyin:"jiÄ", en:"home / family"},
    {han:"æ°´", pinyin:"shuÇ", en:"water"},
    {han:"èŒ¶", pinyin:"chÃ¡", en:"tea"},
    {han:"ç±³é¥­", pinyin:"mÇfÃ n", en:"rice (cooked)"},
    {han:"è‹¹æœ", pinyin:"pÃ­ngguÇ’", en:"apple"},
    {han:"è€å¸ˆ", pinyin:"lÇoshÄ«", en:"teacher"},
    {han:"å­¦ç”Ÿ", pinyin:"xuÃ©sheng", en:"student"},
    {han:"ä¸­å›½", pinyin:"ZhÅngguÃ³", en:"China"},
    {han:"æ³•å›½", pinyin:"FÇguÃ³", en:"France"},
    {han:"ä»Šå¤©", pinyin:"jÄ«ntiÄn", en:"today"},
    {han:"æ˜å¤©", pinyin:"mÃ­ngtiÄn", en:"tomorrow"},
    {han:"ç°åœ¨", pinyin:"xiÃ nzÃ i", en:"now"},
    {han:"å¤šå°‘", pinyin:"duÅshao", en:"how many / how much"},
  ],
  "è¶…å¸‚ä¸»é¢˜ï¼ˆç¤ºä¾‹ 20ï¼‰": [
    {han:"è¶…å¸‚", pinyin:"chÄoshÃ¬", en:"supermarket"},
    {han:"ä¹°", pinyin:"mÇi", en:"to buy"},
    {han:"å–", pinyin:"mÃ i", en:"to sell"},
    {han:"é’±", pinyin:"qiÃ¡n", en:"money"},
    {han:"è´µ", pinyin:"guÃ¬", en:"expensive"},
    {han:"ä¾¿å®œ", pinyin:"piÃ¡nyi", en:"cheap"},
    {han:"æ°´", pinyin:"shuÇ", en:"water"},
    {han:"ç‰›å¥¶", pinyin:"niÃºnÇi", en:"milk"},
    {han:"é¢åŒ…", pinyin:"miÃ nbÄo", en:"bread"},
    {han:"ç±³é¥­", pinyin:"mÇfÃ n", en:"rice"},
    {han:"é¸¡è›‹", pinyin:"jÄ«dÃ n", en:"egg"},
    {han:"è‹¹æœ", pinyin:"pÃ­ngguÇ’", en:"apple"},
    {han:"é¦™è•‰", pinyin:"xiÄngjiÄo", en:"banana"},
    {han:"è‚‰", pinyin:"rÃ²u", en:"meat"},
    {han:"èœ", pinyin:"cÃ i", en:"vegetable / dish"},
    {han:"ä¸€", pinyin:"yÄ«", en:"one"},
    {han:"äºŒ", pinyin:"Ã¨r", en:"two"},
    {han:"ä¸‰", pinyin:"sÄn", en:"three"},
    {han:"å››", pinyin:"sÃ¬", en:"four"},
    {han:"äº”", pinyin:"wÇ”", en:"five"},
  ]
};

let state = {
  view: "vocab",
  deckName: Object.keys(DECKS)[0],
  items: [],
  index: 0,
  showPinyin: true,
  showEnglish: true,
  flipped: false,
  showDone: true,
  filtered: null,
  quiz: { q:null, options:[], correctIndex:0, score:0, total:0, mode:"han->pinyin" }
};

const $ = (sel)=>document.querySelector(sel);
const mainCard = $("#mainCard");
const deckSelect = $("#deckSelect");
const searchInput = $("#search");

function cloneDeck(name){
  return DECKS[name].map(x=>({ ...x, done:false }));
}

function currentList(){
  return state.filtered ?? state.items;
}

function currentItem(){
  const list = currentList();
  return list[state.index] ?? null;
}

function clampIndex(){
  const list = currentList();
  if(list.length === 0){ state.index = 0; return; }
  if(state.index < 0) state.index = list.length-1;
  if(state.index >= list.length) state.index = 0;
}

function setToast(msg){
  alert(msg);
}

function render(){
  clampIndex();
  renderDeckSelect();
  renderView();
  renderPills();
}

function renderPills(){
  document.querySelectorAll(".pill[data-view]").forEach(p=>{
    p.classList.toggle("active", p.dataset.view===state.view);
  });
}

function renderDeckSelect(){
  const names = Object.keys(DECKS);
  if(deckSelect.options.length !== names.length){
    deckSelect.innerHTML = names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");
  }
  deckSelect.value = state.deckName;
}

function escapeHtml(s){
  return (s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

function goto(delta){
  state.flipped = false;
  state.index += delta;
  render();
}

function shuffle(arr){
  for(let i=arr.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

/** ========= Views ========= */
function renderView(){
  if(state.view==="vocab") return renderVocab();
  if(state.view==="dictation") return renderDictation();
  if(state.view==="writing") return renderWriting();
  if(state.view==="quiz") return renderQuiz();
  if(state.view==="custom") return renderCustom();
}

function renderVocab(){
  const it = currentItem();
  const list = currentList();
  if(!it){
    mainCard.innerHTML = `<h2>ğŸ“š è¯æ±‡å¡</h2><p class="muted">å½“å‰æ²¡æœ‰è¯ã€‚è¯·åˆ‡æ¢è¯åº“æˆ–åœ¨â€œè‡ªå®šä¹‰è¯åº“â€é‡Œæ·»åŠ ã€‚</p>`;
    return;
  }
  mainCard.innerHTML = `
    <h2>ğŸ“š è¯æ±‡å¡</h2>
    <div class="flash" id="flash">
      <div class="muted" style="font-size:12px;">ç¬¬ ${state.index+1} / ${list.length} ä¸ª</div>
      <div class="bigHan">${escapeHtml(it.han)}</div>
      <div class="small">
        <div>${state.showPinyin ? `<b>Pinyin:</b> ${escapeHtml(it.pinyin)}` : `<b>Pinyin:</b> <span class="muted">ï¼ˆéšè—ï¼‰</span>`}</div>
        <div>${state.showEnglish ? `<b>EN:</b> ${escapeHtml(it.en)}` : `<b>EN:</b> <span class="muted">ï¼ˆéšè—ï¼‰</span>`}</div>
      </div>
      <div class="meta">
        <span class="chip">ç‚¹å‡»å¡ç‰‡å¯â€œç¿»é¢â€</span>
        <span class="chip">${it.done ? "âœ… å·²æŒæ¡" : "â¬œ æœªæŒæ¡"}</span>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn" id="prev">â† ä¸Šä¸€ä¸ª</button>
        <button class="btn" id="flip">Space ç¿»é¢</button>
        <button class="btn" id="next">ä¸‹ä¸€ä¸ª â†’</button>
        <button class="btn ok" id="mark">${it.done ? "å–æ¶ˆæŒæ¡" : "æ ‡è®°æŒæ¡"}</button>
      </div>
      <div class="hint">å»ºè®®ï¼šå…ˆè¯»æ‹¼éŸ³â†’å†çœ‹ä¸­æ–‡â†’æœ€åé®ä½è‹±æ–‡å¤è¿°ã€‚</div>
    </div>
  `;
  $("#prev").onclick = ()=>goto(-1);
  $("#next").onclick = ()=>goto(1);
  $("#flip").onclick = ()=>{ state.flipped = !state.flipped; applyFlipVocab(); };
  $("#mark").onclick = ()=>{
    it.done = !it.done;
    render();
  };
  $("#flash").onclick = (e)=>{
    // avoid double trigger when clicking buttons
    if(e.target.tagName==="BUTTON") return;
    state.flipped = !state.flipped;
    applyFlipVocab();
  };
  applyFlipVocab();
}

function applyFlipVocab(){
  // ç¿»é¢ï¼šéšè—/æ˜¾ç¤ºæ‹¼éŸ³ & è‹±æ–‡ï¼ˆä¸æ”¹æ€»å¼€å…³ï¼Œåªåœ¨å¡ç‰‡å±‚åšâ€œé®ä½â€ï¼‰
  const it = currentItem();
  if(!it) return;
  // flipped = true => hide pinyin/en regardless toggles
  const showP = state.showPinyin && !state.flipped;
  const showE = state.showEnglish && !state.flipped;
  mainCard.querySelector(".small").innerHTML = `
    <div>${showP ? `<b>Pinyin:</b> ${escapeHtml(it.pinyin)}` : `<b>Pinyin:</b> <span class="muted">ï¼ˆç¿»é¢éšè—ï¼‰</span>`}</div>
    <div>${showE ? `<b>EN:</b> ${escapeHtml(it.en)}` : `<b>EN:</b> <span class="muted">ï¼ˆç¿»é¢éšè—ï¼‰</span>`}</div>
  `;
}

function renderDictation(){
  const it = currentItem();
  const list = currentList();
  if(!it){
    mainCard.innerHTML = `<h2>âœï¸ é»˜å†™</h2><p class="muted">å½“å‰æ²¡æœ‰è¯ã€‚</p>`;
    return;
  }
  const prompt = state.flipped
    ? `<div class="bigHan">${escapeHtml(it.han)}</div>`
    : `
      <div class="bigHan">â“</div>
      <div class="small">
        <div><b>Pinyin:</b> ${escapeHtml(it.pinyin)}</div>
        <div><b>EN:</b> ${escapeHtml(it.en)}</div>
      </div>
    `;
  mainCard.innerHTML = `
    <h2>âœï¸ é»˜å†™</h2>
    <div class="flash">
      <div class="muted" style="font-size:12px;">ç¬¬ ${state.index+1} / ${list.length} ä¸ª</div>
      ${prompt}
      <div class="row" style="margin-top:12px;">
        <button class="btn" id="prev">â† ä¸Šä¸€ä¸ª</button>
        <button class="btn primary" id="reveal">Space æ˜¾ç¤ºç­”æ¡ˆ</button>
        <button class="btn" id="next">ä¸‹ä¸€ä¸ª â†’</button>
      </div>
      <div class="hint">ç©æ³•ï¼šå…ˆåœ¨çº¸ä¸Šå†™å‡ºæ¥ï¼Œå†ç‚¹â€œæ˜¾ç¤ºç­”æ¡ˆâ€å¯¹ç…§ã€‚</div>
    </div>
  `;
  $("#prev").onclick = ()=>goto(-1);
  $("#next").onclick = ()=>goto(1);
  $("#reveal").onclick = ()=>{ state.flipped = !state.flipped; renderDictation(); };
}

let pad = null;

function renderWriting(){
  const it = currentItem();
  const list = currentList();
  mainCard.innerHTML = `
    <h2>ğŸ–Š å†™å­—æ¿ï¼ˆç±³å­—æ ¼ï¼‰</h2>
    <div class="muted" style="font-size:13px; margin-bottom:10px;">
      ç»ƒä¹ è¯ï¼š<b>${escapeHtml(it?.han ?? "ï¼ˆæœªé€‰æ‹©ï¼‰")}</b>
      <span class="muted">ï¼ˆç¬¬ ${Math.min(state.index+1, list.length)} / ${list.length || 0}ï¼‰</span>
    </div>

    <div class="padWrap">
      <div class="padTop">
        <div class="row">
          <label>ç¬”ç²—</label>
          <input id="size" type="range" min="2" max="18" value="8" />
          <span class="chip" id="sizeLabel">8</span>
        </div>
        <div class="row">
          <button class="btn" id="undo">æ’¤é”€</button>
          <button class="btn danger" id="clear">æ¸…ç©º</button>
          <button class="btn" id="prev">â† ä¸Šä¸€ä¸ª</button>
          <button class="btn" id="next">ä¸‹ä¸€ä¸ª â†’</button>
        </div>
      </div>
      <canvas id="canvas"></canvas>
    </div>

    <div class="hint">
      å°å»ºè®®ï¼šè®©å­¦ç”Ÿå…ˆè¯»æ‹¼éŸ³ï¼Œå†ä¸€ç¬”ä¸€åˆ’å†™ã€‚ä½ ä¹Ÿå¯ä»¥è®©ä»–æ¯å†™å®Œä¸€æ¬¡å°±â€œæ’¤é”€â€é‡å†™ä¸€éç»ƒæ‰‹æ„Ÿã€‚
    </div>
  `;

  $("#prev").onclick = ()=>goto(-1);
  $("#next").onclick = ()=>goto(1);

  initPad();
}

function initPad(){
  const canvas = $("#canvas");
  const ctx = canvas.getContext("2d");
  // fit for device pixel ratio
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    drawGrid(ctx, rect.width, rect.height);
    pad?.redraw(ctx);
  }
  // Pad object
  pad = makePad();
  resize();
  window.addEventListener("resize", resize, {passive:true});

  let drawing = false;
  let last = null;

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: t.clientX - rect.left, y: t.clientY - rect.top };
  }

  function start(e){
    e.preventDefault();
    drawing = true;
    last = getPos(e);
    pad.beginStroke(last);
  }
  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    pad.addPoint(p);
    last = p;
    // redraw
    const rect = canvas.getBoundingClientRect();
    drawGrid(ctx, rect.width, rect.height);
    pad.redraw(ctx);
  }
  function end(e){
    if(!drawing) return;
    e.preventDefault();
    drawing = false;
    pad.endStroke();
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);

  canvas.addEventListener("touchstart", start, {passive:false});
  canvas.addEventListener("touchmove", move, {passive:false});
  window.addEventListener("touchend", end, {passive:false});

  const size = $("#size");
  const sizeLabel = $("#sizeLabel");
  size.oninput = ()=>{
    sizeLabel.textContent = size.value;
    pad.setWidth(parseInt(size.value,10));
  };

  $("#clear").onclick = ()=>{
    pad.clear();
    const rect = canvas.getBoundingClientRect();
    drawGrid(ctx, rect.width, rect.height);
  };
  $("#undo").onclick = ()=>{
    pad.undo();
    const rect = canvas.getBoundingClientRect();
    drawGrid(ctx, rect.width, rect.height);
    pad.redraw(ctx);
  };

  // initial width
  pad.setWidth(parseInt(size.value,10));
  // initial draw
  const rect = canvas.getBoundingClientRect();
  drawGrid(ctx, rect.width, rect.height);
}

function drawGrid(ctx, w, h){
  // background
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = "#0a1020";
  ctx.fillRect(0,0,w,h);

  // grid lines
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.lineWidth = 1;

  // outer border
  ctx.strokeRect(10,10,w-20,h-20);

  // center cross
  ctx.beginPath();
  ctx.moveTo(w/2, 10); ctx.lineTo(w/2, h-10);
  ctx.moveTo(10, h/2); ctx.lineTo(w-10, h/2);
  ctx.stroke();

  // diagonals
  ctx.strokeStyle = "rgba(255,255,255,.06)";
  ctx.beginPath();
  ctx.moveTo(10,10); ctx.lineTo(w-10,h-10);
  ctx.moveTo(w-10,10); ctx.lineTo(10,h-10);
  ctx.stroke();

  // faint text watermark: current word
  const it = currentItem();
  if(it?.han){
    ctx.fillStyle = "rgba(255,255,255,.07)";
    ctx.font = "bold 160px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(it.han, w/2, h/2);
  }
}

function makePad(){
  let strokes = []; // each stroke = {points:[], width}
  let current = null;
  let width = 8;

  function beginStroke(p){
    current = { points:[p], width };
    strokes.push(current);
  }
  function addPoint(p){
    if(!current) return;
    current.points.push(p);
  }
  function endStroke(){ current = null; }
  function setWidth(w){ width = w; if(current) current.width = w; }
  function clear(){ strokes = []; current=null; }
  function undo(){ strokes.pop(); current=null; }

  function redraw(ctx){
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    for(const s of strokes){
      const pts = s.points;
      if(pts.length===0) continue;
      ctx.strokeStyle = "rgba(230,238,252,.95)";
      ctx.lineWidth = s.width;
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++){
        ctx.lineTo(pts[i].x, pts[i].y);
      }
      ctx.stroke();
    }
  }

  return { beginStroke, addPoint, endStroke, setWidth, clear, undo, redraw };
}

function renderQuiz(){
  mainCard.innerHTML = `
    <h2>ğŸ§  å°æµ‹éªŒï¼ˆé€‰æ‹©é¢˜ï¼‰</h2>
    <div class="row" style="margin-bottom:10px;">
      <button class="btn ${state.quiz.mode==="han->pinyin" ? "primary":""}" id="m1">çœ‹ä¸­æ–‡é€‰æ‹¼éŸ³</button>
      <button class="btn ${state.quiz.mode==="han->en" ? "primary":""}" id="m2">çœ‹ä¸­æ–‡é€‰è‹±æ–‡</button>
      <button class="btn" id="newQ">å‡ºä¸€é¢˜</button>
      <button class="btn ok" id="resetQ">æ¸…é›¶</button>
    </div>
    <div class="qBox" id="qBox"></div>
  `;

  $("#m1").onclick = ()=>{ state.quiz.mode="han->pinyin"; newQuestion(); };
  $("#m2").onclick = ()=>{ state.quiz.mode="han->en"; newQuestion(); };
  $("#newQ").onclick = ()=>newQuestion();
  $("#resetQ").onclick = ()=>{ state.quiz.score=0; state.quiz.total=0; newQuestion(); };

  if(!state.quiz.q) newQuestion();
  else paintQuestion();
}

function newQuestion(){
  const list = currentList();
  if(list.length < 4){
    $("#qBox").innerHTML = `<p class="muted">è¯å¤ªå°‘å•¦ï¼ˆè‡³å°‘éœ€è¦ 4 ä¸ªè¯ï¼‰ã€‚æ¢ä¸ªè¯åº“æˆ–æ·»åŠ è‡ªå®šä¹‰è¯ã€‚</p>`;
    return;
  }
  const qIndex = Math.floor(Math.random()*list.length);
  const q = list[qIndex];

  // build options
  const indices = new Set([qIndex]);
  while(indices.size < 4){
    indices.add(Math.floor(Math.random()*list.length));
  }
  const opts = [...indices].map(i=>list[i]);

  // shuffle options
  const shuffled = shuffle(opts.slice());
  const correctIndex = shuffled.findIndex(x=>x.han===q.han);

  state.quiz.q = q;
  state.quiz.options = shuffled;
  state.quiz.correctIndex = correctIndex;
  paintQuestion(true);
}

function paintQuestion(fresh=false){
  const q = state.quiz.q;
  if(!q){
    $("#qBox").innerHTML = `<p class="muted">ç‚¹â€œå‡ºä¸€é¢˜â€å¼€å§‹ã€‚</p>`;
    return;
  }
  const ask = `<div class="muted" style="font-size:12px;">é¢˜ç›®ï¼šé€‰æ‹©æ­£ç¡®çš„ ${state.quiz.mode==="han->pinyin" ? "æ‹¼éŸ³" : "è‹±æ–‡"}</div>
               <div class="bigHan" style="margin-top:10px;">${escapeHtml(q.han)}</div>`;
  const optsHtml = state.quiz.options.map((o, idx)=>{
    const label = state.quiz.mode==="han->pinyin" ? o.pinyin : o.en;
    return `<div class="opt" data-idx="${idx}">${escapeHtml(label)}</div>`;
  }).join("");

  $("#qBox").innerHTML = `
    ${ask}
    ${optsHtml}
    <div class="score">
      <div>å¾—åˆ†ï¼š<b>${state.quiz.score}</b> / ${state.quiz.total}</div>
      <div class="muted">æç¤ºï¼šç­”å®Œè‡ªåŠ¨å‡ºä¸‹ä¸€é¢˜</div>
    </div>
  `;

  document.querySelectorAll(".opt").forEach(el=>{
    el.onclick = ()=>{
      const idx = parseInt(el.dataset.idx,10);
      const correct = idx === state.quiz.correctIndex;
      state.quiz.total += 1;
      if(correct) state.quiz.score += 1;

      // mark
      document.querySelectorAll(".opt").forEach((oEl)=>{
        const i = parseInt(oEl.dataset.idx,10);
        if(i === state.quiz.correctIndex) oEl.classList.add("good");
        else if(i === idx) oEl.classList.add("bad");
        oEl.style.pointerEvents = "none";
      });

      setTimeout(()=>newQuestion(), 650);
    };
  });
}

function renderCustom(){
  mainCard.innerHTML = `
    <h2>ğŸ§© è‡ªå®šä¹‰è¯åº“</h2>
    <p class="muted" style="margin-top:0;">
      ä½ å¯ä»¥æŠŠè¯¾å ‚è¯ç›´æ¥ç²˜è¿›æ¥ã€‚æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªè¯ï¼Œä¸‰åˆ—ç”¨é€—å·åˆ†éš”ï¼š<br/>
      <span class="kbd">ä¸­æ–‡, pinyin, English</span>
    </p>

    <div class="split" style="margin-top:10px;">
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">æ–°è¯åº“åç§°</div>
        <input id="newDeckName" type="text" placeholder="ä¾‹å¦‚ï¼šHSK1 Week 1 (Chaoze)" />
        <div class="muted" style="font-size:12px; margin:12px 0 6px;">ç²˜è´´è¯è¡¨</div>
        <textarea id="newDeckText" placeholder="ä¾‹å¦‚ï¼š
ä½ å¥½, nÇ hÇo, hello
è°¢è°¢, xiÃ¨xie, thanks
å†è§, zÃ ijiÃ n, goodbye"></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="importDeck">å¯¼å…¥ä¸ºæ–°è¯åº“</button>
          <button class="btn danger" id="wipeCustom">æ¸…ç©ºè¾“å…¥</button>
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">å¿«é€Ÿç”Ÿæˆæ¨¡æ¿</div>
        <div class="flash">
          <div class="small">
            ä½ ä¹Ÿå¯ä»¥æŠŠä½ ä¹‹å‰è®©æˆ‘åšçš„è¡¨æ ¼ï¼ˆä¸­æ–‡/æ‹¼éŸ³/è‹±æ–‡ï¼‰æŒ‰è¡Œç²˜è´´è¿›æ¥ã€‚
            <br/>å¯¼å…¥åä¼šè‡ªåŠ¨å‡ºç°åœ¨å³ä¾§â€œè¯åº“â€ä¸‹æ‹‰æ¡†ä¸­ã€‚
          </div>
          <div class="row" style="margin-top:12px;">
            <button class="btn" id="fillSample">å¡«å…¥ç¤ºä¾‹</button>
            <button class="btn" id="switchToDeck">åˆ‡åˆ°æ–°è¯åº“</button>
          </div>
          <div class="hint">æ³¨æ„ï¼šè¿™æ˜¯æœ¬åœ°ç‰ˆï¼ˆä¸è”ç½‘ï¼‰ã€‚å¦‚æœä½ è¦å¤šäººå…±äº«ï¼Œå¯ä»¥æŠŠå¯¼å…¥åçš„è¯åº“å†™å›ä»£ç ï¼Œæˆ–è€…æˆ‘å¯ä»¥å¸®ä½ åšâ€œä¸Šä¼ /äº‘ç«¯ä¿å­˜â€ã€‚</div>
        </div>
      </div>
    </div>
  `;

  $("#wipeCustom").onclick = ()=> $("#newDeckText").value = "";
  $("#fillSample").onclick = ()=>{
    $("#newDeckName").value = "HSK1 - Greeting Pack";
    $("#newDeckText").value =
`ä½ å¥½, nÇ hÇo, hello
è°¢è°¢, xiÃ¨xie, thanks
ä¸å®¢æ°”, bÃº kÃ¨qi, you're welcome
å†è§, zÃ ijiÃ n, goodbye
å¯¹ä¸èµ·, duÃ¬buqÇ, sorry
æ²¡å…³ç³», mÃ©i guÄnxi, it's okay`;
  };

  $("#importDeck").onclick = ()=>{
    const name = ($("#newDeckName").value || "").trim();
    const text = ($("#newDeckText").value || "").trim();
    if(!name){ setToast("è¯·å…ˆå¡«å†™è¯åº“åç§°"); return; }
    if(!text){ setToast("è¯·å…ˆç²˜è´´è¯è¡¨"); return; }

    const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);
    const items = [];
    for(const line of lines){
      const parts = line.split(",").map(x=>x.trim());
      if(parts.length < 3){
        setToast(`æ ¼å¼ä¸å¯¹ï¼š${line}\néœ€è¦ï¼šä¸­æ–‡, pinyin, English`);
        return;
      }
      items.push({ han: parts[0], pinyin: parts[1], en: parts.slice(2).join(", "), done:false });
    }
    DECKS[name] = items;
    state.deckName = name;
    state.items = cloneDeck(name);
    state.filtered = null;
    state.index = 0;
    setToast(`å·²å¯¼å…¥ï¼š${name}ï¼ˆ${items.length} ä¸ªè¯ï¼‰`);
    render();
  };

  $("#switchToDeck").onclick = ()=>{
    state.deckName = $("#newDeckName").value.trim() || state.deckName;
    render();
  };
}

/** ========= Controls ========= */
document.querySelectorAll(".pill[data-view]").forEach(p=>{
  p.onclick = ()=>{
    state.view = p.dataset.view;
    state.flipped = false;
    render();
  };
});

deckSelect.onchange = ()=>{
  state.deckName = deckSelect.value;
  state.items = cloneDeck(state.deckName);
  state.filtered = null;
  state.index = 0;
  state.flipped = false;
  state.quiz.q = null;
  render();
};

$("#togglePinyin").onclick = ()=>{
  state.showPinyin = !state.showPinyin;
  $("#togglePinyin").textContent = `ğŸ‘€ æ‹¼éŸ³ï¼š${state.showPinyin ? "æ˜¾ç¤º":"éšè—"}`;
  render();
};
$("#toggleEnglish").onclick = ()=>{
  state.showEnglish = !state.showEnglish;
  $("#toggleEnglish").textContent = `ğŸ‘€ è‹±æ–‡ï¼š${state.showEnglish ? "æ˜¾ç¤º":"éšè—"}`;
  render();
};

$("#shuffle").onclick = ()=>{
  state.items = shuffle(state.items);
  state.filtered = null;
  state.index = 0;
  state.flipped = false;
  state.quiz.q = null;
  render();
};

$("#reset").onclick = ()=>{
  state.items = cloneDeck(state.deckName);
  state.filtered = null;
  state.index = 0;
  state.flipped = false;
  state.quiz.q = null;
  render();
};

searchInput.oninput = ()=>{
  const q = searchInput.value.trim().toLowerCase();
  if(!q){
    state.filtered = null;
    state.index = 0;
    render();
    return;
  }
  state.filtered = state.items.filter(it=>{
    return (it.han||"").toLowerCase().includes(q)
      || (it.pinyin||"").toLowerCase().includes(q)
      || (it.en||"").toLowerCase().includes(q);
  });
  state.index = 0;
  state.flipped = false;
  render();
};

$("#printSheet").onclick = ()=>{
  const list = currentList();
  if(list.length===0){ setToast("å½“å‰æ²¡æœ‰è¯"); return; }
  const repeat = parseInt($("#repeatCount").value,10);
  const html = makePrintHtml(list, repeat);
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
};

function makePrintHtml(list, repeat){
  const rows = list.map(it=>{
    const boxes = Array.from({length: repeat}).map(()=>`<div class="box"></div>`).join("");
    return `
      <div class="row">
        <div class="word">${escapeHtml(it.han)}</div>
        <div class="meta">${escapeHtml(it.pinyin)} Â· ${escapeHtml(it.en)}</div>
        <div class="boxes">${boxes}</div>
      </div>
    `;
  }).join("");

  return `
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HSK1 ç»ƒå­—çº¸</title>
<style>
  @page{ size: A4; margin: 14mm; }
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  h1{ font-size: 16px; margin: 0 0 8px; }
  .note{ font-size:12px; color:#444; margin:0 0 12px; }
  .row{
    border:1px solid #ddd; border-radius:10px;
    padding:10px; margin-bottom:10px;
  }
  .word{ font-size: 28px; font-weight: 800; }
  .meta{ font-size: 12px; color:#555; margin-top:2px; }
  .boxes{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .box{
    width:34px; height:34px; border:1px solid #bbb; border-radius:6px;
    background:
      linear-gradient(#fff,#fff),
      linear-gradient(to right, rgba(0,0,0,.08) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(0,0,0,.08) 1px, transparent 1px);
    background-size: 100% 100%, 50% 100%, 100% 50%;
    background-position: 0 0, 0 0, 0 0;
  }
</style>
</head>
<body>
  <h1>HSK1 ç»ƒå­—çº¸ï¼ˆ${escapeHtml(state.deckName)}ï¼‰</h1>
  <p class="note">å»ºè®®ï¼šå…ˆè¯»æ‹¼éŸ³ï¼Œå†å†™å­—ã€‚æ¯ä¸ªæ ¼å†™ä¸€æ¬¡ã€‚</p>
  ${rows}
  <script>window.print();</script>
</body>
</html>`;
}

/** ========= Keyboard ========= */
window.addEventListener("keydown", (e)=>{
  if(e.key === "ArrowLeft") goto(-1);
  if(e.key === "ArrowRight") goto(1);
  if(e.key === " "){
    // Space toggles flip in vocab/dictation
    if(state.view === "vocab"){
      state.flipped = !state.flipped;
      applyFlipVocab();
      e.preventDefault();
    }else if(state.view === "dictation"){
      state.flipped = !state.flipped;
      renderDictation();
      e.preventDefault();
    }
  }
});

/** ========= Init ========= */
function init(){
  // setup
  state.items = cloneDeck(state.deckName);
  $("#togglePinyin").textContent = `ğŸ‘€ æ‹¼éŸ³ï¼šæ˜¾ç¤º`;
  $("#toggleEnglish").textContent = `ğŸ‘€ è‹±æ–‡ï¼šæ˜¾ç¤º`;
  render();
}
init();
</script>
</body>
</html>
